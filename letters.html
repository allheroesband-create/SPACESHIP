<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Letters</title>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

   body {
  font-family: system-ui, -apple-system,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
  background: radial-gradient(circle at top,#072c6b 0%,#001133 40%,#000814 100%);
  color:#e8eeff;
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:flex-start;  /* ← stretch でもいいけど、上寄せの方が自然 */
  overflow:auto;           /* ← hidden をやめてスクロールOKに */
}

    /* 暗転レイヤー（Ride Mode） */
    #rideOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.45); /* ちょっと暗くするだけ */
  /* backdrop-filter:blur(2px);  ← ボケるのが嫌なら消す */
  opacity:0;
  pointer-events:none;          /* ← ここが超重要：常にクリックを通す */
  transition:opacity .25s;
  z-index:50;
}

#rideOverlay.active{
  opacity:1;
  /* pointer-events は変えない */
}


    /* Ride用カーソル */
    #rideCursor{
      position:fixed;
      width:8px;
      height:8px;
      border-radius:999px;
      background:#fff;
      filter:drop-shadow(0 0 6px #aee4ff);
      mix-blend-mode:screen;
      pointer-events:none;
      opacity:0;
      transition:opacity .2s;
      z-index:200;
    }

    .cursor-trail{
      position:fixed;
      width:6px;
      height:6px;
      border-radius:999px;
      background:rgba(190,235,255,0.9);
      mix-blend-mode:screen;
      pointer-events:none;
      z-index:150;
      animation:trailFade .6s linear forwards;
    }
    @keyframes trailFade{
      0%{opacity:1; transform:scale(1);}
      100%{opacity:0; transform:scale(.2);}
    }

    .app{
      width:100%;
      max-width:1200px;
      margin:16px;
      border-radius:24px;
      background:rgba(0,10,30,.92);
      border:1px solid rgba(150,180,255,.2);
      box-shadow:0 0 40px rgba(0,0,0,.6);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      z-index:10;
    }

    header{
      padding:16px 24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid rgba(120,170,255,.2);
      background:linear-gradient(to right,rgba(10,40,90,.9),rgba(0,10,40,.9));
    }
    header h1{
      font-size:24px;
      letter-spacing:.25em;
      text-transform:uppercase;
    }
    header .subtitle{font-size:12px;opacity:.7;}

    #rideModeBtn{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 18px;
      border:none;
      border-radius:16px;
      background:linear-gradient(135deg,#8ce8ff,#4bc0ff);
      color:#00111a;
      font-weight:700;
      letter-spacing:.1em;
      cursor:pointer;
      box-shadow:0 0 14px rgba(120,200,255,.8);
      transition:.2s;
    }
    #rideModeBtn:hover{
      transform:translateY(-2px) scale(1.03);
      box-shadow:0 0 20px rgba(150,220,255,1);
    }
    #rideModeBtn svg{width:18px;height:18px;fill:#00111a;}

    main{
      flex:1;
      display:flex;
      min-height:0;
      overflow:hidden;
    }

    .galaxy-panel{
      flex:1.2;
      border-right:1px solid rgba(120,170,255,.2);
      background:radial-gradient(circle at center,rgba(60,120,255,.15),rgba(0,8,30,1) 45%,#000814);
      position:relative;
      overflow:hidden;
    }
    #galaxy{width:100%;height:100%;display:block;}

    .hint{
      position:absolute;
      left:16px;
      bottom:10px;
      font-size:11px;
      opacity:.7;
      pointer-events:none;
    }

    .letter-panel{
  flex:1;
  display:flex;
  flex-direction:column;
  padding:16px 18px;
  gap:12px;
  background:linear-gradient(to bottom,rgba(0,5,20,.9),rgba(0,0,0,.9));
  /* overflow:hidden; ← これを削除 */
}


    .current-letter{
      flex:1;
      padding:14px;
      border-radius:16px;
      background:rgba(10,20,50,.92);
      border:1px solid rgba(150,180,255,.25);
      overflow:auto;
    }
    .letter-title{font-size:18px;font-weight:700;margin-top:8px;}
    .letter-body{margin-top:10px;line-height:1.9;}

    .color-dot{
      display:inline-block;
      width:10px;
      height:10px;
      border-radius:999px;
      margin-right:6px;
    }

    .form-panel{
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(150,180,255,.25);
      background:rgba(8,12,30,.95);
    }

    .form-row{display:flex;gap:8px;margin-bottom:8px;}
    .field{flex:1;display:flex;flex-direction:column;font-size:12px;gap:4px;}

    input,textarea{
      border-radius:10px;
      border:1px solid rgba(120,150,255,.35);
      background:rgba(5,10,30,.9);
      color:#e8eeff;
      padding:6px 8px;
      font-size:13px;
    }

    textarea{
      resize:vertical;
      min-height:140px;
      max-height:300px;
      line-height:1.9;
    }

    .btn{
      border:none;
      border-radius:999px;
      padding:8px 16px;
      background:linear-gradient(135deg,#4b8dff,#90c2ff);
      cursor:pointer;
      font-weight:600;
      font-size:12px;
      color:#00111a;
      box-shadow:0 0 10px rgba(120,150,255,.6);
    }

    #previewArea{
      display:none;
      margin-top:6px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(150,180,255,.35);
      background:rgba(80,110,180,.14);
      box-shadow:0 0 12px rgba(140,180,255,.25);
      max-height:160px;
      overflow:auto;
      font-size:13px;
    }

    /* Story View（Ride の結果） */
    #storyView{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.85);
      backdrop-filter:blur(5px);
      display:none;
      z-index:300;
      overflow-y:auto;
      padding:40px 20px;
    }
    #storyView.show{display:block;}

    #storyContainer{
      max-width:620px;
      margin:0 auto 60px;
    }

    .story-letter{
      background:rgba(255,255,255,.08);
      border-left:4px solid #9bd7ff;
      border-radius:12px;
      padding:16px;
      margin-bottom:18px;
    }

    #closeStoryBtn{
      position:fixed;
      top:18px;
      right:18px;
      padding:8px 15px;
      border-radius:999px;
      border:none;
      background:#9bd7ff;
      color:#00111a;
      font-weight:700;
      cursor:pointer;
    }

    @media (max-width:900px){
      main{flex-direction:column;}
      .galaxy-panel{height:45vh;}
      .letter-panel{height:55vh;}
    }
  </style>
</head>
<body>

<div id="rideOverlay"></div>
<div id="rideCursor"></div>

<div class="app">
  <header>
    <div>
      <h1>LETTERS</h1>
      <div class="subtitle">Space for chatting</div>
    </div>
    <button id="rideModeBtn">
      <svg viewBox="0 0 24 24">
        <path d="M2 12l20-8-8 20-2-8-8-4z"></path>
      </svg>
      RIDE MODE
    </button>
  </header>

  <main>
    <section class="galaxy-panel">
      <svg id="galaxy"></svg>
      <div class="hint">● click → read letter / Ride Mode → trace the galaxy</div>
    </section>

    <section class="letter-panel">
      <div class="current-letter" id="currentLetter">
        <h2>SELECTED LETTER</h2>
        <p style="opacity:.7;">There is no letter yet — write the first one.</p>
      </div>

      <div id="previewArea"></div>

      <div class="form-panel">
        <form id="letterForm">
          <div class="form-row">
            <div class="field">
              <label for="fromName">From:</label>
              <input id="fromName" required>
            </div>
            <div class="field">
              <label for="toName">To:</label>
              <input id="toName">
            </div>
          </div>

          <div class="form-row">
            <div class="field">
              <label for="title">Title:</label>
              <input id="title" required>
            </div>
            <div class="field" style="flex:0 0 110px;">
              <label for="color">Color:</label>
              <input type="color" id="color" value="#ffb3ff">
            </div>
          </div>

          <div class="field">
            <label for="body">Body:</label>
            <textarea id="body" required></textarea>
          </div>

          <div style="display:flex;gap:8px;margin-top:10px;">
            <button type="button" id="previewBtn" class="btn" style="background:#6b6bff;">PREVIEW</button>
            <button type="submit" class="btn">SEND</button>
          </div>
        </form>
      </div>
    </section>
  </main>
</div>

<div id="storyView">
  <button id="closeStoryBtn">Close ride</button>
  <div id="storyContainer"></div>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ===== Supabase 初期化（再宣言防止）=====
const SUPABASE_URL = "https://tovffzyfssluxmbzhctb.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvdmZmenlmc3NsdXhtYnpoY3RiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NTE0MDAsImV4cCI6MjA4MDQyNzQwMH0.7SOXnMuCvo_d5L3YvpFdBIkmXzMg7QLGT3Tvmi-Ky8Q";

if (!window._supabaseClient) {
  window._supabaseClient =
    window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
}
const supabase = window._supabaseClient;

  let letters = [];
  let selectedId = null;
  let rideOn = false;
  let rideTraceIds = [];
  let lastCursorX = 0;
  let lastCursorY = 0;

  const rideOverlay = document.getElementById("rideOverlay");
  const rideCursor = document.getElementById("rideCursor");

  // ===== 手紙ロード =====
  async function loadLetters() {
    const { data, error } = await supabase
      .from("letters")
      .select("*")
      .order("created_at", { ascending: true });

    if (error) {
      console.error("Supabase load error:", error);
      letters = [];
      return;
    }

    letters = (data || []).map(row => ({
      id: row.id,
      fromName: row.from_name,
      toName: row.to_name,
      title: row.title,
      body: row.body,
      color: row.color || "#ffffff",
      createdAt: new Date(row.created_at).getTime()
    }));

    renderGalaxy();
    if (letters.length) {
      selectLetter(letters[letters.length - 1].id);
    }
  }

  // ===== 銀河配置 =====
  function computePositions(w,h){
    const cx = w/2, cy=h/2;
    const golden = Math.PI*(3-Math.sqrt(5));
    return letters.map((_,i)=>{
      const r = 40 + i*16;
      const a = i*golden;
      return {
        x: cx + Math.cos(a)*r,
        y: cy + Math.sin(a)*r*0.6
      };
    });
  }

  function areConnected(a,b){
    const af=(a.fromName||"").trim();
    const at=(a.toName||"").trim();
    const bf=(b.fromName||"").trim();
    const bt=(b.toName||"").trim();
    return (
      (at && at===bf) ||
      (bt && bt===af)
    );
  }

  function computeBeams(){
    const beams=[];
    letters.forEach((L,i)=>{
      const to=(L.toName||"").trim();
      if(!to) return;
      const j = letters.findIndex(other => (other.fromName||"").trim()===to);
      if(j>=0) beams.push({from:i,to:j});
    });
    return beams;
  }

  // ===== 銀河描画 =====
  function renderGalaxy(){
    const svg = document.getElementById("galaxy");
    const rect = svg.getBoundingClientRect();
    const W = rect.width || 800;
    const H = rect.height || 600;

    svg.setAttribute("viewBox",`0 0 ${W} ${H}`);
    while(svg.firstChild) svg.removeChild(svg.firstChild);
    if(!letters.length) return;

    const svgNS = "http://www.w3.org/2000/svg";
    const positions = computePositions(W,H);

    // 背景薄線
    for(let i=0;i<letters.length;i++){
      for(let j=i+1;j<letters.length;j++){
        if(areConnected(letters[i],letters[j])){
          const l = document.createElementNS(svgNS,"line");
          l.setAttribute("x1",positions[i].x);
          l.setAttribute("y1",positions[i].y);
          l.setAttribute("x2",positions[j].x);
          l.setAttribute("y2",positions[j].y);
          l.setAttribute("stroke","#9fb4ff");
          l.setAttribute("stroke-width","0.6");
          l.setAttribute("stroke-opacity","0.18");
          svg.appendChild(l);
        }
      }
    }

    // 光の川ビーム
    const beams = computeBeams();
    beams.forEach(({from,to})=>{
      const p1=positions[from], p2=positions[to];
      createBeam(svg,p1.x,p1.y,p2.x,p2.y);
    });

    // ノード
    letters.forEach((L,i)=>{
      const g = document.createElementNS(svgNS,"g");
      g.style.cursor="pointer";

      const pos = positions[i];
      const isSelected = (L.id===selectedId);

      const halo = document.createElementNS(svgNS,"circle");
      halo.setAttribute("cx",pos.x);
      halo.setAttribute("cy",pos.y);
      halo.setAttribute("r", isSelected?20:16);
      halo.setAttribute("fill",L.color);
      halo.setAttribute("fill-opacity","0.35");
      g.appendChild(halo);

      const c = document.createElementNS(svgNS,"circle");
      c.setAttribute("cx",pos.x);
      c.setAttribute("cy",pos.y);
      c.setAttribute("r", isSelected?8:6);
      c.setAttribute("fill",L.color);
      c.setAttribute("stroke","#fff");
      c.setAttribute("stroke-width","1.3");
      g.appendChild(c);

      const t = document.createElementNS(svgNS,"text");
      t.setAttribute("x",pos.x+10);
      t.setAttribute("y",pos.y+3);
      t.setAttribute("fill","#e7ecff");
      t.setAttribute("font-size","10");
      t.textContent = L.title || "(no title)";
      g.appendChild(t);

      g.addEventListener("click",()=>{ selectLetter(L.id); });

      // Ride中：なぞった順を記録（pointerenter）
      g.addEventListener("pointerenter",()=>{
        if(rideOn && !rideTraceIds.includes(L.id)){
          rideTraceIds.push(L.id);
        }
      });

      svg.appendChild(g);
    });
  }

  // 光の川
  function createBeam(svg,x1,y1,x2,y2){
    const svgNS = "http://www.w3.org/2000/svg";
    const dx=x2-x1, dy=y2-y1;

    const glow = document.createElementNS(svgNS,"line");
    glow.setAttribute("x1",x1);
    glow.setAttribute("y1",y1);
    glow.setAttribute("x2",x2);
    glow.setAttribute("y2",y2);
    glow.setAttribute("stroke","rgba(120,230,255,0.35)");
    glow.setAttribute("stroke-width","5");
    glow.setAttribute("stroke-linecap","round");
    svg.appendChild(glow);

    const core = document.createElementNS(svgNS,"line");
    core.setAttribute("x1",x1);
    core.setAttribute("y1",y1);
    core.setAttribute("x2",x2);
    core.setAttribute("y2",y2);
    core.setAttribute("stroke","rgba(230,255,255,0.7)");
    core.setAttribute("stroke-width","1.3");
    core.setAttribute("stroke-linecap","round");
    svg.appendChild(core);

    const count=14;
    for(let i=0;i<count;i++){
      const t0=Math.random()*0.6;
      const t1=t0+0.3+Math.random()*0.4;
      const sx=x1+dx*t0, sy=y1+dy*t0;
      const mx=x1+dx*((t0+t1)/2), my=y1+dy*((t0+t1)/2);
      const ex=x1+dx*t1, ey=y1+dy*t1;

      const p = document.createElementNS(svgNS,"circle");
      p.setAttribute("cx",sx);
      p.setAttribute("cy",sy);
      p.setAttribute("r",1+Math.random()*1.8);
      p.setAttribute("fill","#fff");
      p.setAttribute("opacity","0.4");
      svg.appendChild(p);

      const aX=document.createElementNS(svgNS,"animate");
      aX.setAttribute("attributeName","cx");
      aX.setAttribute("values",`${sx};${mx};${ex}`);
      aX.setAttribute("dur",(1+Math.random()).toFixed(2)+"s");
      aX.setAttribute("repeatCount","indefinite");
      aX.setAttribute("begin",(Math.random()*2).toFixed(2)+"s");
      p.appendChild(aX);

      const aY=document.createElementNS(svgNS,"animate");
      aY.setAttribute("attributeName","cy");
      aY.setAttribute("values",`${sy};${my};${ey}`);
      aY.setAttribute("dur",aX.getAttribute("dur"));
      aY.setAttribute("repeatCount","indefinite");
      aY.setAttribute("begin",aX.getAttribute("begin"));
      p.appendChild(aY);
    }
  }

  // ===== 手紙表示 =====
  function selectLetter(id){
    selectedId = id;
    const L = letters.find(l=>l.id===id);
    const box = document.getElementById("currentLetter");
    if(!L){
      box.innerHTML = "<h2>SELECTED LETTER</h2><p>No letter.</p>";
      return;
    }

    const dateStr = new Date(L.createdAt).toLocaleString("ja-JP");
    box.innerHTML = `
      <h2>SELECTED LETTER</h2>
      <div class="letter-title">
        <span class="color-dot" style="background:${L.color}"></span>
        ${L.title}
      </div>
      <div class="letter-body">
        <b>FROM:</b> ${L.fromName || "名無し"}<br>
        <b>TO:</b> ${L.toName || "(anyone)"}<br>
        <b>DATE:</b> ${dateStr}<br><br>
        ${L.body.replace(/\n/g,"<br>")}
      </div>
    `;
    renderGalaxy();
  }

  // ===== Ride Mode ON/OFF =====
  document.getElementById("rideModeBtn").addEventListener("click",()=>{
    rideOn = !rideOn;
    rideOverlay.classList.toggle("active",rideOn);
    rideCursor.style.opacity = rideOn?1:0;

    if(!rideOn){
      // Ride 終了 → トレースした順でStory表示
      if(rideTraceIds.length>0){
        openStoryView();
      }
    }else{
      rideTraceIds = [];
    }
  });

  document.addEventListener("pointermove",(e)=>{
    lastCursorX = e.clientX;
    lastCursorY = e.clientY;
    if(!rideOn) return;

    rideCursor.style.left = e.clientX+"px";
    rideCursor.style.top  = e.clientY+"px";

    const trail = document.createElement("div");
    trail.className="cursor-trail";
    trail.style.left = e.clientX+"px";
    trail.style.top  = e.clientY+"px";
    document.body.appendChild(trail);
    setTimeout(()=>trail.remove(),600);
  });

  // ===== Ride Story View =====
  function openStoryView(){
    const container = document.getElementById("storyContainer");
    container.innerHTML = "";

    rideTraceIds.forEach(id=>{
      const L = letters.find(l=>l.id===id);
      if(!L) return;
      const div = document.createElement("div");
      div.className="story-letter";
      div.innerHTML = `
        <h3><span class="color-dot" style="background:${L.color}"></span>${L.title}</h3>
        <div style="opacity:.7;font-size:12px;margin-bottom:8px;">
          FROM: ${L.fromName || "名無し"} / TO: ${L.toName || "(anyone)"}
        </div>
        <div>${L.body.replace(/\n/g,"<br>")}</div>
      `;
      container.appendChild(div);
    });

    document.getElementById("storyView").classList.add("show");
    rideTraceIds = [];
  }

  document.getElementById("closeStoryBtn").addEventListener("click",()=>{
    document.getElementById("storyView").classList.remove("show");
  });

  // ===== PREVIEW =====
  document.getElementById("previewBtn").addEventListener("click",()=>{
    const from = document.getElementById("fromName").value.trim();
    const to   = document.getElementById("toName").value.trim();
    const title= document.getElementById("title").value.trim();
    const body = document.getElementById("body").value.trim();
    const color= document.getElementById("color").value;

    if(!from || !title || !body){
      alert("From / Title / Body を入力してね。");
      return;
    }

    const box = document.getElementById("previewArea");
    box.style.display="block";
    box.innerHTML = `
      <div style="font-size:11px;opacity:.7;margin-bottom:4px;">PREVIEW</div>
      <div><span class="color-dot" style="background:${color}"></span><b>${title}</b></div>
      <div style="font-size:12px;opacity:.7;margin:4px 0 6px;">
        FROM: ${from} / TO: ${to || "(anyone)"}
      </div>
      <div>${body.replace(/\n/g,"<br>")}</div>
    `;
  });

  // ===== フォーム送信 =====
  document.getElementById("letterForm").addEventListener("submit",async (e)=>{
    e.preventDefault();

    const from = document.getElementById("fromName").value.trim();
    const to   = document.getElementById("toName").value.trim();
    const title= document.getElementById("title").value.trim();
    const body = document.getElementById("body").value.trim();
    const color= document.getElementById("color").value;

    if(!from || !title || !body){
      alert("From / Title / Body は必須です。");
      return;
    }

    const { data, error } = await supabase
      .from("letters")
      .insert({
        from_name: from,
        to_name: to || null,
        title,
        body,
        color
      })
      .select()
      .single();

    if(error){
      console.error("Supabase insert error:", error);
      alert("送信に失敗しました。");
      return;
    }

    // 追加した分をローカルにも反映
    letters.push({
      id: data.id,
      fromName: data.from_name,
      toName: data.to_name,
      title: data.title,
      body: data.body,
      color: data.color || "#ffffff",
      createdAt: new Date(data.created_at).getTime()
    });

    document.getElementById("previewArea").style.display="none";
    document.getElementById("title").value="";
    document.getElementById("body").value="";

    renderGalaxy();
    selectLetter(data.id);
  });

  // ===== init =====
  window.addEventListener("load",()=>{
    loadLetters();
  });
</script>
</body>
</html>

