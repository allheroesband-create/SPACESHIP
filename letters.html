<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Letters</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      background: radial-gradient(circle at top, #072c6b 0%, #001133 40%, #000814 100%);
      color: #f5f7ff;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app {
      width: 100%;
      max-width: 1200px;
      margin: 16px;
      border-radius: 24px;
      background: rgba(0, 10, 30, 0.9);
      box-shadow: 0 0 40px rgba(0, 0, 0, 0.6);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid rgba(120, 170, 255, 0.15);
      backdrop-filter: blur(12px);
    }

    header {
      padding: 16px 24px;
      border-bottom: 1px solid rgba(120, 170, 255, 0.18);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(to right, rgba(10, 40, 90, 0.9), rgba(0, 10, 40, 0.9));
    }

    header h1 {
      font-size: 24px;
      letter-spacing: 0.25em;
      text-transform: uppercase;
    }

    header .subtitle {
      font-size: 12px;
      opacity: 0.7;
    }

    main {
      flex: 1;
      display: flex;
      min-height: 0;
    }

    .galaxy-panel {
      flex: 1.2;
      border-right: 1px solid rgba(120, 170, 255, 0.18);
      position: relative;
      overflow: hidden;
      background: radial-gradient(circle at center, rgba(60, 120, 255, 0.15) 0%, rgba(0, 8, 30, 1) 45%, #000814 100%);
    }

    #galaxy {
      width: 100%;
      height: 100%;
      display: block;
    }

    .hint {
      position: absolute;
      bottom: 10px;
      left: 16px;
      font-size: 11px;
      opacity: 0.7;
      pointer-events: none;
    }

    .letter-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px 18px;
      gap: 16px;
      background: linear-gradient(to bottom, rgba(0, 5, 20, 0.9), rgba(0, 0, 0, 0.9));
    }

    .current-letter {
      flex: 1;
      padding: 12px 14px;
      border-radius: 16px;
      background: rgba(10, 20, 50, 0.9);
      border: 1px solid rgba(140, 180, 255, 0.2);
      overflow: auto;
    }

    .current-letter h2 {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: #cdd8ff;
      margin-bottom: 8px;
      opacity: 0.9;
    }

    .letter-meta {
      font-size: 13px;
      margin-bottom: 8px;
      line-height: 1.7;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(180, 210, 255, 0.4);
      margin-right: 6px;
      margin-bottom: 4px;
    }

    .tag-label {
      opacity: 0.6;
      text-transform: uppercase;
      letter-spacing: 0.15em;
    }

    .letter-title {
      font-size: 16px;
      font-weight: 600;
      margin: 8px 0;
      word-break: break-all;
    }

    .letter-body {
      margin-top: 8px;
      font-size: 13px;
      line-height: 1.9;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .letter-empty {
      font-size: 13px;
      opacity: 0.7;
      margin-top: 12px;
    }

    .color-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      margin-right: 6px;
      border: 1px solid rgba(0, 0, 0, 0.4);
      vertical-align: -1px;
    }

    .form-panel {
      padding: 12px 14px;
      border-radius: 16px;
      background: rgba(5, 10, 30, 0.95);
      border: 1px solid rgba(120, 170, 255, 0.25);
    }

    .form-panel h3 {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: #cdd8ff;
      margin-bottom: 10px;
    }

    .form-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .field {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    label {
      font-size: 11px;
      opacity: 0.7;
    }

    input[type="text"],
    textarea,
    input[type="color"] {
      border-radius: 10px;
      border: 1px solid rgba(130, 170, 255, 0.4);
      background: rgba(5, 10, 30, 0.9);
      color: #f5f7ff;
      font-size: 13px;
      padding: 6px 8px;
      outline: none;
    }

    input[type="text"]:focus,
    textarea:focus {
      border-color: rgba(190, 220, 255, 0.9);
      box-shadow: 0 0 0 1px rgba(150, 190, 255, 0.5);
    }

    textarea {
      resize: vertical;
      min-height: 60px;
      max-height: 140px;
    }

    input[type="color"] {
      padding: 0;
      height: 32px;
      cursor: pointer;
    }

    .form-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 12px;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-weight: 600;
      background: linear-gradient(135deg, #4b8dff, #90c2ff);
      color: #020617;
      box-shadow: 0 0 10px rgba(80, 150, 255, 0.5);
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 0 4px rgba(80, 150, 255, 0.5);
    }

    .reply-label {
      font-size: 11px;
      opacity: 0.7;
    }

    @media (max-width: 900px) {
      main {
        flex-direction: column;
      }
      .galaxy-panel {
        height: 45vh;
      }
      .letter-panel {
        height: 55vh;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>LETTERS</h1>
        <div class="subtitle">Space for chatting</div>
      </div>
    </header>

    <main>
      <!-- 銀河ビュー -->
      <section class="galaxy-panel">
        <svg id="galaxy"></svg>
        <div class="hint">● click the node and read letters / You can write a new letter from the form</div>
      </section>

      <!-- 右側：手紙表示 ＋ 投稿フォーム -->
      <section class="letter-panel">
        <div class="current-letter" id="currentLetter">
          <h2>SELECTED LETTER</h2>
          <div class="letter-empty">
            There is no letter yet<br>
            Please write the very first letter using the form at the bottom right.
          </div>
        </div>

        <div class="form-panel">
          <h3>WRITE A LETTER</h3>
          <form id="letterForm">
            <div class="form-row">
              <div class="field">
                <label for="fromName">From: (anonymous accepted)</label>
                <input type="text" id="fromName" placeholder="e.g., Superman" required>
              </div>
              <div class="field">
                <label for="toName">To: (the person you’re replying to)</label>
                <input type="text" id="toName" placeholder="e.g., Mcqueen">
              </div>
            </div>

            <div class="form-row">
              <div class="field">
                <label for="title">title</label>
                <input type="text" id="title" placeholder="e.g., Red blood sun" required>
              </div>
              <div class="field" style="flex:0 0 110px;">
                <label for="color">Letter color</label>
                <input type="color" id="color" value="#ffb3ff">
              </div>
            </div>

            <div class="field">
              <label for="body">body</label>
              <textarea id="body" placeholder="Write your letter here" required></textarea>
            </div>

            <div class="form-footer">
              <div class="reply-label" id="replyInfo">You are sending a new letter.</div>
              <button type="submit" class="btn">Send</button>
            </div>
          </form>
        </div>
      </section>
    </main>
  </div>

  <!-- Supabase クライアント読み込み -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ------------ Supabase 初期化 -------------
    // ★ここを自分のプロジェクトの値に書き換える★
    const SUPABASE_URL = "https://tovffzyfssluxmbzhctb.supabase.co"; // ← Project URL
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRvdmZmenlmc3NsdXhtYnpoY3RiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NTE0MDAsImV4cCI6MjA4MDQyNzQwMH0.7SOXnMuCvo_d5L3YvpFdBIkmXzMg7QLGT3Tvmi-Ky8Q";        // ← anon public key

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /** @type {Array<{id:string, fromName:string, toName:string, title:string, body:string, color:string, createdAt:number}>} */
    let letters = [];
    let selectedId = null;
    let replyTargetName = null; // 返信時に自動で宛名に入れる用

    // ------------ データ読み込み（Supabase） -------------

    async function loadLetters() {
      const { data, error } = await supabase
        .from("letters")
        .select("*")
        .order("created_at", { ascending: true });

      if (error) {
        console.error("Failed to load letters:", error);
        letters = [];
        return;
      }

      letters = (data || []).map(row => ({
        id: row.id,
        fromName: row.from_name,
        toName: row.to_name,
        title: row.title,
        body: row.body,
        color: row.color || "#ffffff",
        createdAt: new Date(row.created_at).getTime()
      }));
    }

    // ------------ 銀河描画部分(SVG) -------------

    function areConnected(a, b) {
      const aFrom = (a.fromName || "").trim();
      const aTo = (a.toName || "").trim();
      const bFrom = (b.fromName || "").trim();
      const bTo = (b.toName || "").trim();

      if (!aFrom && !aTo && !bFrom && !bTo) return false;

      return (
        (aTo && aTo === bFrom) ||
        (bTo && bTo === aFrom) ||
        (aFrom && aFrom === bFrom && aFrom !== "") ||
        (aTo && aTo === bTo && aTo !== "")
      );
    }

    // 「ある手紙の宛名 = 誰かの差出人」なら、その手紙 → その相手、にビーム
    function computeBeams() {
      const beams = [];
      letters.forEach((letter, i) => {
        const toName = (letter.toName || "").trim();
        if (!toName) return;
        for (let j = 0; j < letters.length; j++) {
          if (j === i) continue;
          const other = letters[j];
          const fromNameOther = (other.fromName || "").trim();
          if (fromNameOther && fromNameOther === toName) {
            beams.push({ from: i, to: j });
            break;
          }
        }
      });
      return beams;
    }

    function renderGalaxy() {
      const svg = document.getElementById("galaxy");
      const rect = svg.getBoundingClientRect();
      const width = rect.width || 600;
      const height = rect.height || 400;

      svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
      while (svg.firstChild) svg.removeChild(svg.firstChild);

      if (!letters.length) return;

      const svgNS = "http://www.w3.org/2000/svg";

      // --- defs: 矢印・グロー ---
      const defs = document.createElementNS(svgNS, "defs");

      // arrow marker
      const marker = document.createElementNS(svgNS, "marker");
      marker.setAttribute("id", "arrowhead");
      marker.setAttribute("markerWidth", "6");
      marker.setAttribute("markerHeight", "6");
      marker.setAttribute("refX", "5");
      marker.setAttribute("refY", "3");
      marker.setAttribute("orient", "auto");
      marker.setAttribute("markerUnits", "strokeWidth");
      const path = document.createElementNS(svgNS, "path");
      path.setAttribute("d", "M0,0 L6,3 L0,6 Z");
      path.setAttribute("fill", "#8dfbff");
      path.setAttribute("fill-opacity", "0.98");
      marker.appendChild(path);
      defs.appendChild(marker);

      // ビームのグロー
      const beamGlow = document.createElementNS(svgNS, "filter");
      beamGlow.setAttribute("id", "beamGlow");
      beamGlow.setAttribute("x", "-50%");
      beamGlow.setAttribute("y", "-50%");
      beamGlow.setAttribute("width", "200%");
      beamGlow.setAttribute("height", "200%");
      let fe = document.createElementNS(svgNS, "feGaussianBlur");
      fe.setAttribute("stdDeviation", "3.5");
      fe.setAttribute("result", "blur");
      beamGlow.appendChild(fe);
      let fe2 = document.createElementNS(svgNS, "feColorMatrix");
      fe2.setAttribute("in", "blur");
      fe2.setAttribute("type", "matrix");
      fe2.setAttribute(
        "values",
        "0 0 0 0 0.55  0 0 0 0 1  0 0 0 0 1  0 0 0 0.9 0"
      );
      beamGlow.appendChild(fe2);
      defs.appendChild(beamGlow);

      // ノードのグロー
      const starGlow = document.createElementNS(svgNS, "filter");
      starGlow.setAttribute("id", "starGlow");
      starGlow.setAttribute("x", "-120%");
      starGlow.setAttribute("y", "-120%");
      starGlow.setAttribute("width", "340%");
      starGlow.setAttribute("height", "340%");
      let s1 = document.createElementNS(svgNS, "feGaussianBlur");
      s1.setAttribute("stdDeviation", "3");
      s1.setAttribute("result", "blur");
      starGlow.appendChild(s1);
      let s2 = document.createElementNS(svgNS, "feColorMatrix");
      s2.setAttribute("in", "blur");
      s2.setAttribute("type", "matrix");
      s2.setAttribute(
        "values",
        "1 0 0 0 0.05  0 1 0 0 0.25  0 0 1 0 0.7  0 0 0 1 0"
      );
      starGlow.appendChild(s2);
      defs.appendChild(starGlow);

      svg.appendChild(defs);

      // --- ノード位置計算（銀河スパイラル） ---
      const centerX = width / 2;
      const centerY = height / 2;
      const goldenAngle = Math.PI * (3 - Math.sqrt(5));

      const positions = letters.map((letter, i) => {
        const radius = 30 + i * 12;
        const angle = i * goldenAngle;
        const x = centerX + Math.cos(angle) * radius;
        const y = centerY + Math.sin(angle) * radius * 0.6;
        return { x, y };
      });

      // --- 背景ライン（方向なし／薄い） ---
      for (let i = 0; i < letters.length; i++) {
        for (let j = i + 1; j < letters.length; j++) {
          if (areConnected(letters[i], letters[j])) {
            const line = document.createElementNS(svgNS, "line");
            line.setAttribute("x1", positions[i].x);
            line.setAttribute("y1", positions[i].y);
            line.setAttribute("x2", positions[j].x);
            line.setAttribute("y2", positions[j].y);
            line.setAttribute("stroke", "#9fb4ff");
            line.setAttribute("stroke-width", "0.45");
            line.setAttribute("stroke-opacity", "0.14");
            line.setAttribute("stroke-linecap", "round");
            svg.appendChild(line);
          }
        }
      }

      // --- ビーム（光の粒の川） ---
      const beams = computeBeams();
      const beamNodes = new Set();
      beams.forEach(b => {
        beamNodes.add(b.from);
        beamNodes.add(b.to);
      });

      beams.forEach(({ from, to }) => {
        const x1 = positions[from].x;
        const y1 = positions[from].y;
        const x2 = positions[to].x;
        const y2 = positions[to].y;
        const dx = x2 - x1;
        const dy = y2 - y1;

        // 太いグローの本流
        const glowLine = document.createElementNS(svgNS, "line");
        glowLine.setAttribute("x1", x1);
        glowLine.setAttribute("y1", y1);
        glowLine.setAttribute("x2", x2);
        glowLine.setAttribute("y2", y2);
        glowLine.setAttribute("stroke", "#7ef5ff");
        glowLine.setAttribute("stroke-width", "4");
        glowLine.setAttribute("stroke-linecap", "round");
        glowLine.setAttribute("stroke-opacity", "0.55");
        glowLine.setAttribute("filter", "url(#beamGlow)");
        svg.appendChild(glowLine);

        // 中心ライン（うっすら）
        const coreLine = document.createElementNS(svgNS, "line");
        coreLine.setAttribute("x1", x1);
        coreLine.setAttribute("y1", y1);
        coreLine.setAttribute("x2", x2);
        coreLine.setAttribute("y2", y2);
        coreLine.setAttribute("stroke", "#e6ffff");
        coreLine.setAttribute("stroke-width", "1");
        coreLine.setAttribute("stroke-linecap", "round");
        coreLine.setAttribute("stroke-opacity", "0.4");
        coreLine.setAttribute("marker-end", "url(#arrowhead)");
        svg.appendChild(coreLine);

        // 光の粒たち
        const particleCount = 10;
        for (let p = 0; p < particleCount; p++) {
          const t0 = Math.random() * 0.6; // 途中から湧く感じ
          const t1 = t0 + 0.4 + Math.random() * 0.4;
          const startX = x1 + dx * t0;
          const startY = y1 + dy * t0;
          const midX = x1 + dx * ((t0 + t1) / 2);
          const midY = y1 + dy * ((t0 + t1) / 2);
          const endX = x1 + dx * t1;
          const endY = y1 + dy * t1;

          const particle = document.createElementNS(svgNS, "circle");
          particle.setAttribute("cx", startX);
          particle.setAttribute("cy", startY);
          particle.setAttribute("r", 0.9 + Math.random() * 1.8);
          particle.setAttribute("fill", "#faffff");
          const baseOpacity = 0.4 + Math.random() * 0.5;
          particle.setAttribute("opacity", baseOpacity.toString());

          const cxAnim = document.createElementNS(svgNS, "animate");
          cxAnim.setAttribute("attributeName", "cx");
          cxAnim.setAttribute("values", `${startX};${midX};${endX}`);
          cxAnim.setAttribute("keyTimes", "0;0.5;1");
          cxAnim.setAttribute("dur", (0.9 + Math.random() * 1.8).toFixed(2) + "s");
          cxAnim.setAttribute("repeatCount", "indefinite");
          cxAnim.setAttribute("begin", (Math.random() * 2).toFixed(2) + "s");
          particle.appendChild(cxAnim);

          const cyAnim = document.createElementNS(svgNS, "animate");
          cyAnim.setAttribute("attributeName", "cy");
          cyAnim.setAttribute("values", `${startY};${midY};${endY}`);
          cyAnim.setAttribute("keyTimes", "0;0.5;1");
          cyAnim.setAttribute("dur", cxAnim.getAttribute("dur"));
          cyAnim.setAttribute("repeatCount", "indefinite");
          cyAnim.setAttribute("begin", cxAnim.getAttribute("begin"));
          particle.appendChild(cyAnim);

          const opAnim = document.createElementNS(svgNS, "animate");
          opAnim.setAttribute("attributeName", "opacity");
          opAnim.setAttribute("values", `${baseOpacity};1;0;${baseOpacity}`);
          opAnim.setAttribute("dur", (0.9 + Math.random() * 1.5).toFixed(2) + "s");
          opAnim.setAttribute("repeatCount", "indefinite");
          opAnim.setAttribute("begin", (Math.random() * 2).toFixed(2) + "s");
          particle.appendChild(opAnim);

          svg.appendChild(particle);
        }
      });

      // --- ノード（恒星＋バチバチ） ---
      letters.forEach((letter, index) => {
        const g = document.createElementNS(svgNS, "g");
        g.setAttribute("data-id", letter.id);
        g.style.cursor = "pointer";

        const isSelected = letter.id === selectedId;
        const isHot = beamNodes.has(index);
        const pos = positions[index];

        // ハロ（反応する光）
        const halo = document.createElementNS(svgNS, "circle");
        halo.setAttribute("cx", pos.x);
        halo.setAttribute("cy", pos.y);
        halo.setAttribute("r", isSelected ? 22 : 18);
        halo.setAttribute("fill", letter.color || "#ffffff");
        halo.setAttribute("fill-opacity", isHot ? "0.7" : "0.45");
        halo.setAttribute("filter", "url(#starGlow)");

        // HOT なノードはバチバチアニメーション
        if (isHot) {
          const haloAnim = document.createElementNS(svgNS, "animate");
          haloAnim.setAttribute("attributeName", "r");
          haloAnim.setAttribute("values", `${isSelected ? 20 : 18};${(isSelected ? 26 : 23)};${isSelected ? 21 : 19}`);
          haloAnim.setAttribute("dur", (0.9 + Math.random() * 0.8).toFixed(2) + "s");
          haloAnim.setAttribute("repeatCount", "indefinite");
          haloAnim.setAttribute("begin", (Math.random() * 1.5).toFixed(2) + "s");
          halo.appendChild(haloAnim);

          const opAnim = document.createElementNS(svgNS, "animate");
          opAnim.setAttribute("attributeName", "fill-opacity");
          opAnim.setAttribute("values", "0.25;0.9;0.4;0.75;0.25");
          opAnim.setAttribute("dur", (1.1 + Math.random() * 0.9).toFixed(2) + "s");
          opAnim.setAttribute("repeatCount", "indefinite");
          opAnim.setAttribute("begin", (Math.random() * 1.5).toFixed(2) + "s");
          halo.appendChild(opAnim);
        }

        g.appendChild(halo);

        // 中心のコア
        const circle = document.createElementNS(svgNS, "circle");
        circle.setAttribute("cx", pos.x);
        circle.setAttribute("cy", pos.y);
        circle.setAttribute("r", isSelected ? 9 : 7);
        circle.setAttribute("fill", letter.color || "#ffffff");
        circle.setAttribute("fill-opacity", "1");
        circle.setAttribute("stroke", "#ffffff");
        circle.setAttribute("stroke-opacity", isSelected ? "1" : "0.8");
        circle.setAttribute("stroke-width", isSelected ? "1.8" : "1.2");
        g.appendChild(circle);

        // 周りのスパーク
        const baseSparkCount = isHot ? 9 : 5;
        for (let s = 0; s < baseSparkCount; s++) {
          const angle = Math.random() * Math.PI * 2;
          const radius = (isSelected ? 18 : 15) + Math.random() * (isHot ? 7 : 4);
          const sx = pos.x + Math.cos(angle) * radius;
          const sy = pos.y + Math.sin(angle) * radius;

          const spark = document.createElementNS(svgNS, "circle");
          spark.setAttribute("cx", sx);
          spark.setAttribute("cy", sy);
          spark.setAttribute("r", 0.7 + Math.random() * (isHot ? 1.8 : 1.2));
          spark.setAttribute("fill", "#f8fdff");
          const baseOpacity = isHot
            ? 0.4 + Math.random() * 0.5
            : 0.2 + Math.random() * 0.4;
          spark.setAttribute("opacity", baseOpacity.toString());
          spark.setAttribute("filter", "url(#starGlow)");

          const twinkle = document.createElementNS(svgNS, "animate");
          twinkle.setAttribute("attributeName", "opacity");
          twinkle.setAttribute(
            "values",
            isHot
              ? `${baseOpacity};1;0.2;0.9;${baseOpacity}`
              : `${baseOpacity};0.8;0.3;${baseOpacity}`
          );
          twinkle.setAttribute("dur", (isHot
            ? 0.9 + Math.random() * 1.1
            : 1.8 + Math.random() * 2.0).toFixed(2) + "s");
          twinkle.setAttribute("repeatCount", "indefinite");
          twinkle.setAttribute("begin", (Math.random() * 2).toFixed(2) + "s");
          spark.appendChild(twinkle);

          g.appendChild(spark);
        }

        // タイトルテキスト
        const text = document.createElementNS(svgNS, "text");
        text.setAttribute("x", pos.x + 10);
        text.setAttribute("y", pos.y + 3);
        text.setAttribute("font-size", "10");
        text.setAttribute("fill", "#e5ebff");
        text.setAttribute("opacity", "0.9");
        text.textContent = letter.title || "(no title)";
        g.appendChild(text);

        g.addEventListener("click", () => {
          selectLetter(letter.id);
        });

        svg.appendChild(g);
      });
    }

    // ------------ 手紙表示 -------------

    function selectLetter(id) {
      selectedId = id;
      const letter = letters.find(l => l.id === id);
      const container = document.getElementById("currentLetter");

      if (!letter) {
        container.innerHTML = `
          <h2>SELECTED LETTER</h2>
          <div class="letter-empty">No letter was found</div>
        `;
        renderGalaxy();
        return;
      }

      replyTargetName = letter.fromName || "";
      updateReplyInfo();

      const created = new Date(letter.createdAt || Date.now());
      const dateStr = created.toLocaleString("ja-JP", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit"
      });

      container.innerHTML = `
        <h2>SELECTED LETTER</h2>
        <div class="letter-meta">
          <div class="tag">
            <span class="tag-label">FROM</span>
            <span>${escapeHtml(letter.fromName || "名無し")}</span>
          </div>
          <div class="tag">
            <span class="tag-label">TO</span>
            <span>${escapeHtml(letter.toName || "（誰でも）")}</span>
          </div>
          <div class="tag">
            <span class="tag-label">DATE</span>
            <span>${dateStr}</span>
          </div>
        </div>
        <div class="letter-title">
          <span class="color-dot" style="background:${letter.color || "#ffffff"}"></span>
          ${escapeHtml(letter.title || "")}
        </div>
        <div class="letter-body">
          ${escapeHtml(letter.body || "").replace(/\n/g, "<br>")}
        </div>
      `;

      const toInput = document.getElementById("toName");
      if (replyTargetName) {
        toInput.value = replyTargetName;
      }

      renderGalaxy();
    }

    function updateReplyInfo() {
      const info = document.getElementById("replyInfo");
      if (replyTargetName) {
        info.textContent = `It’s okay to send this as a reply to the currently selected letter (from: ${replyTargetName}).`;
      } else {
        info.textContent = "You are sending a new letter.";
      }
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // ------------ フォーム送信（Supabaseに保存） -------------

    function setupForm() {
      const form = document.getElementById("letterForm");
      const fromInput = document.getElementById("fromName");
      const toInput = document.getElementById("toName");
      const titleInput = document.getElementById("title");
      const colorInput = document.getElementById("color");
      const bodyInput = document.getElementById("body");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const fromName = fromInput.value.trim();
        const toName = toInput.value.trim();
        const title = titleInput.value.trim();
        const body = bodyInput.value.trim();
        const color = colorInput.value || "#ffffff";

        if (!fromName || !title || !body) {
          alert("差出人・タイトル・本文は必須です。");
          return;
        }

        const { data, error } = await supabase
          .from("letters")
          .insert({
            from_name: fromName,
            to_name: toName || null,
            title: title,
            body: body,
            color: color
          })
          .select()
          .single();

        if (error) {
          console.error("Failed to insert letter:", error);
          alert("Failed to send the letter. Please try again later.");
          return;
        }

        const letter = {
          id: data.id,
          fromName: data.from_name,
          toName: data.to_name,
          title: data.title,
          body: data.body,
          color: data.color || "#ffffff",
          createdAt: new Date(data.created_at).getTime()
        };

        letters.push(letter);
        renderGalaxy();
        selectLetter(letter.id);

        titleInput.value = "";
        bodyInput.value = "";
      });
    }

    // ------------ 初期化 -------------

    async function init() {
      await loadLetters();
      setupForm();
      renderGalaxy();
      updateReplyInfo();

      if (letters.length) {
        const last = letters[letters.length - 1];
        selectLetter(last.id);
      }
    }

    window.addEventListener("load", () => {
      init();
    });

    window.addEventListener("resize", () => {
      renderGalaxy();
    });
  </script>
</body>
</html>
